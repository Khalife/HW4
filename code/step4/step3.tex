\section*{Step 3}
1. \begin{eqnarray*}
		\tilde{\pi}_{\theta}(u,w) &=& \pi_{\theta}(u)(\prod_{i=1}^{N}\bar{\pi}(w_i;x_i'\beta + \sigma z_i'u))\\
		&=& \frac{1}{exp(l(\theta))}\phi(u)exp(l_c(\theta | u)) (\prod_{i=1}^{N}\bar{\pi}(w_i;x_i'\beta + \sigma z_i'u)) \\
		&=& \frac{1}{exp(l(\theta))}\phi(u)  \prod_{i=1}^{N} Z cosh(\frac{x_i'\beta + \sigma z_i'u}{2}) \rho(w_i) \textbf{1}_{\mathbb{R}^{+}}(w_i) exp(-w(x_i'\beta + \sigma z_i'u)^2/2)\\ 
		& & \qquad \qquad \qquad \qquad \qquad \qquad \qquad \qquad \qquad \qquad \frac{exp(Y_i(x_i'\beta + \sigma z_i'u))}{1+exp(x_i'\beta + \sigma z_i'u)}\\ 
\end{eqnarray*}~\\
Writing $cosh(x)=exp(-x/2)(1+exp(x))\frac{1}{2}$, we obtain :
\begin{eqnarray*}
	\tilde{\pi}_{\theta}(u,w) &=&  \frac{1}{exp(l(\theta))}\phi(u)  \prod_{i=1}^{N} Z  \rho(w_i) \textbf{1}_{\mathbb{R}^{+}}(w_i) exp(Y_i(x_i'\beta + \sigma z_i'u)-(x_i'\beta + \sigma z_i'u)/2-w_i(x_i'\beta + \sigma z_i'u)^2/2)\\
	&=& \frac{1}{exp(l(\theta))}\phi(u) Z^{N} \prod_{i=1}^{N}exp(Y_i x_i' \beta -x_i'\beta/2)\\
	& &\qquad \qquad \qquad \qquad \qquad \prod_{i=1}^{N}\rho(w_i) \textbf{1}_{\mathbb{R}^{+}}(w_i) exp(\sigma(Y_i-1/2)z_i'u-w_i(x_i'\beta+\sigma z_i'u)^2/2) \\
	&=& C(\theta)\phi(u)	\prod_{i=1}^{N}\rho(w_i) \textbf{1}_{\mathbb{R}^{+}}(w_i) exp(\sigma(Y_i-1/2)z_i'u-w_i(x_i'\beta+\sigma z_i'u)^2/2) \\	
\end{eqnarray*}~\\
~\\
With $\boxed{C(\theta)=\frac{1}{exp(l(\theta))}\phi(u) Z^{N} \prod_{i=1}^{N}exp(Y_i x_i' \beta -x_i'\beta/2)}$,
$$	\boxed{\tilde{\pi}_{\theta}(u,w) = C(\theta)\phi(u)	\prod_{i=1}^{N}\rho(w_i) \textbf{1}_{\mathbb{R}^{+}}(w_i) exp(\sigma(Y_i-1/2)z_i'u-w_i(x_i'\beta+\sigma z_i'u)^2/2) }$$
2. Let us factorize the expression of $\tilde{\pi}_{\theta}(u,w)$  under the form :
\begin{eqnarray*}
	\tilde{\pi}_{\theta}(u,w)&=& h(\theta,  w, \beta, \sigma , ...) exp(-\frac{1}{2}u^t u - \sum_{i=1}^{N}\frac{ w_i}{2}\sigma^2(z_i'u)^2 +\sum_{i=1}^{N}\sigma(Y_i-\frac{1}{2})z_i'u- w_{i}x_i'\beta \sigma z_i'u)~\\
	&=& h(\theta,  w, \beta, \sigma , ...)exp(-\frac{1}{2}u^t (I+\sigma^{2}\sum_{i=1}^{n}\frac{ w_i}{2}z_i z_i')u + \sigma<u, \sum_{i=1}^{N}((Y_i-\frac{1}{2})- w_{i}x_i'\beta)z_i>)
\end{eqnarray*}

Where h does not depend on u. We can directly identify the density of a Gaussian :
$$ \tilde{\pi}_{\theta}(u | w) \quad \propto \quad exp(-\frac{1}{2}u^t (I+\sigma^{2}\sum_{i=1}^{n}\frac{ w_i}{2}z_i z_i')u + \sigma<u, \sum_{i=1}^{N}((Y_i-\frac{1}{2})- w_{i}x_i'\beta)z_i>)$$
i.e (we can identify since the Gaussian is normalized)
$$ \boxed{\tilde{\pi}_{\theta}(u | w) \quad = \mathcal{N}(\mu_{\theta},\Gamma_{\theta}(w))}$$
~\\
With $\boxed{\Gamma_{\theta}(w)=(I+\sigma^{2}\sum_{i=1}^{n}\frac{ w_i}{2}z_i z_i')^{-1}}$, and $\boxed{\mu_{\theta}(w)=\sigma \Gamma_{\theta}(w)\sum_{i=1}^{N}((Y_i-\frac{1}{2})-w_ix_i'\beta)z_i}$.~\\
~\\
3. We use the same reasoning as the previous question. 
\begin{eqnarray*}
	\tilde{\pi}_{\theta}(w | u) & \underset{w}\propto & \prod_{i=1}^{N}\rho(w_i)\textbf{1}_{R^{+}}(w_i)exp(-\frac{w_i}{2}(x_i'\beta+\sigma z_i'u)^2) \\
	& \underset{w}\propto & \prod_{i=1}^{N}Zcosh(\frac{x_i'\beta + \sigma z_i'u}{2})\textbf{1}_{R^{+}}(w_i)exp(-\frac{w_i}{2}(x_i'\beta+\sigma z_i'u)^2)\\
\end{eqnarray*}~\\
Since $cosh(x)=cosh(|x|)$,
\begin{eqnarray*}
	\tilde{\pi}_{\theta}(w | u)
	& \underset{w}\propto & \prod_{i=1}^{N}Zcosh(\frac{|x_i'\beta + \sigma z_i'u|}{2})\textbf{1}_{R^{+}}(w_i)exp(-\frac{w_i}{2}(x_i'\beta+\sigma z_i'u)^2)\\
	& \underset{w}\propto & \prod_{i=1}^{N}\bar{\pi}(w_i ;|x_i'\beta + \sigma z_i' u|)
\end{eqnarray*}~\\
Since the last line a function normalized in w, i.e
\begin{eqnarray*}
	\int_{\Omega}\prod_{i=1}^{N}\bar{\pi}(w_i ;|x_i'\beta + \sigma z_i' u|)dw &=& \prod_{i=1}^{N} \int_{\Omega_i}\bar{\pi}(w_i ;|x_i'\beta + \sigma z_i' u|)dw_i\\
	&=& 1
\end{eqnarray*}~\\    	
We have 
$$\boxed{\tilde{\pi}_{\theta}(w | u)= \prod_{i=1}^{N}\bar{\pi}(w_i ;|x_i'\beta + \sigma z_i' u|)}$$
~\\
4.~\\
~\\
5. To sample $(w_{1},...,w_{N},u)$ from $\tilde{\pi}_{\theta}(u,w)$, we will use a Gibbs Sampler 	

\begin{algorithm}
	\caption{Gibbs Sampler to sample from $\tilde{\pi}_{\theta}$}\label{RS}
	Given, $w_{1}^{(0)}, ..., w_{N}^{(0)}$~\\
	~\\
	Loop on k~\\
	Draw $u^{(k+1)}$ from $\pi_{\theta}(. | w^{(k)}) = \mathcal{N}(\mu_{\theta},\Gamma_{\theta}(\omega))$~\\
	-for i=1:N~\\
	$w_{i}^{(k+1)}$ drawn thanks to HW1Sampler(.,$|x_i'\beta + \sigma z_i' u^{(k+1)}|/2)$\\
	-end for i~\\
	end k~\\
	return $(u^{(k)},w^{(k)})_{1\leq k \leq K}$
\end{algorithm}~\\
~\\
Cf code for implementation.~\\
~\\
6. One can use a sample generated by the previous algorithm to approximate the integral of $\nabla l(\theta)$.
Let us denote $H_{\theta}(u)=\sum_{i=1}^{N}(Y_i-s(x_i'\beta+\sigma z_i'u)) \left(
\begin{smallmatrix}
x_i\\ z_i'u
\end{smallmatrix}
\right)$. Then, 
$$\nabla l(\theta) = \int \int H_{\theta}(u)\tilde{\pi}_{\theta}(u,w)dudw   \approx \frac{1}{K}\sum_{k=1}^{K} H_{\theta}(u^k) $$
\begin{algorithm}
	\caption{Algorithm to approximate $ \nabla l(\theta)$}\label{RS}
	Sample a chain $(u^{(k)},w^{(k)})_{1\leq k \leq K}$ from distribution $\tilde{\pi}_{\theta}$ with algorithm 1.~\\
	~\\
	return $\frac{1}{K}\sum_{k=1}^{K} H_{\theta}(u^k)$
\end{algorithm}~\\
~\\

 c.f. code directory for implementation.
